<!DOCTYPE html>
<html lang="en">
<head>
    </head>
<body>
    <script src="userdata.js"></script>

    <script>
        // --- CONFIGURATION ---
        const PAYSTACK_PUBLIC_KEY = 'YOUR_PAYSTACK_PUBLIC_KEY'; // REPLACE WITH YOUR ACTUAL PUBLIC KEY
        const FORMSPREE_ENDPOINT = 'YOUR_FORMSPREE_ENDPOINT'; // REPLACE WITH YOUR ACTUAL FORMSPREE ENDPOINT
        const EXTERNAL_JOIN_LINK = 'https://your-external-join-link.com'; // REPLACE WITH THE ACTUAL EXTERNAL LINK FOR JOIN COMMUNITY BUTTON
        const PAYMENT_AMOUNT_NAIRA = 600; // Amount in Naira
        const SPLASH_VIDEO_URL = 'https://thisiceconsort.github.io/truematch/splash.mp4';
        const SPLASH_IMAGE_FALLBACK_URL = 'https://via.placeholder.com/1920x1080/121212/FFFFFF?text=TrueMatch+Splash+Fallback'; // Provide your actual fallback image URL here
        const SPLASH_PLAY_INTERVAL_MS = 30 * 60 * 1000; // 30 minutes in milliseconds
        const LAST_SPLASH_PLAY_TIME_KEY = 'lastSplashPlayTime';


        // --- DOM Elements ---
        const splashScreen = document.getElementById('splash-screen');
        const splashVideo = document.getElementById('splash-video');
        const splashImageFallback = document.getElementById('splash-image-fallback');
        const mainPageContent = document.getElementById('main-page-content');
        const mainHeader = document.getElementById('main-header');
        const headerSpacer = document.getElementById('header-spacer');
        const tagline = document.querySelector('.tagline');
        const cardCodeInput = document.getElementById('cardCodeInput');
        const verifyButton = document.getElementById('verifyButton');
        const verificationMessage = document.getElementById('verificationMessage');
        const userProfileDisplay = document.getElementById('userProfileDisplay');
        const joinCommunitySection = document.getElementById('joinCommunitySection');
        const joinCommunityButton = document.getElementById('joinCommunityButton');
        const joinSuccessMessage = document.getElementById('joinSuccessMessage');

        // Modals
        const addCreateModal = document.getElementById('addCreateModal');
        const addCreateModalCloseButton = addCreateModal.querySelector('.close-button');
        const createGayCardLink = document.getElementById('createGayCardLink');
        const registrationModal = document.getElementById('registrationModal');
        const registrationForm = document.getElementById('registrationForm');
        const registrationModalCloseButton = registrationModal.querySelector('.close-button');
        const resourcesMenuModal = document.getElementById('resourcesMenuModal');
        const resourcesMenuCloseButton = resourcesMenuModal.querySelector('.close-button');


        // Nav items
        const homeNavItem = document.getElementById('homeNavItem');
        const registerNavItem = document.getElementById('registerNavItem');
        const navItems = document.querySelectorAll('.bottom-nav .nav-item');
        const faqSectionTitle = document.getElementById('faq-section-title');

        // Header icon links
        const openLiveLink = document.getElementById('openLiveLink');
        const openResourcesMenuModalLink = document.getElementById('openResourcesMenuModalLink');


        // --- Splash Screen Logic ---
        document.addEventListener('DOMContentLoaded', () => {
            const lastPlayTime = localStorage.getItem(LAST_SPLASH_PLAY_TIME_KEY);
            const currentTime = new Date().getTime();

            // Check if 30 minutes have passed or if it's the first visit
            if (!lastPlayTime || (currentTime - lastPlayTime > SPLASH_PLAY_INTERVAL_MS)) {
                // Play video splash
                splashVideo.src = SPLASH_VIDEO_URL; // Set video source
                splashVideo.load(); // Load the video
                splashVideo.oncanplaythrough = () => {
                    splashVideo.play().then(() => {
                        console.log('Video playing');
                        startSplashScreenSequence();
                    }).catch(error => {
                        console.error('Video playback failed, falling back to image:', error);
                        showImageFallback();
                        startSplashScreenSequence();
                    });
                };
                splashVideo.onerror = () => {
                    console.error('Video loading failed, falling back to image.');
                    showImageFallback();
                    startSplashScreenSequence();
                };
                localStorage.setItem(LAST_SPLASH_PLAY_TIME_KEY, currentTime);
            } else {
                // Skip video, go straight to main content or show image if preferred
                splashScreen.style.display = 'none';
                mainPageContent.classList.add('fade-in');
            }

            // Set the href for the "Join Community" button
            joinCommunityButton.href = EXTERNAL_JOIN_LINK;
            // Initial setup for navigation items (always run)
            setActiveNavItemOnScroll();
            // Check for hash in URL to open modal, but only if splash screen isn't blocking
            setTimeout(() => {
                if (window.location.hash === '#joinCommunitySection' && !joinSuccessMessage.classList.contains('show')) {
                    // This section was commented out in your original code, so keeping it inactive.
                    // If you want to open registration modal via hash, you'd enable similar logic.
                }
            }, 4500);
        });

        function showImageFallback() {
            splashVideo.classList.add('hidden'); // Hide the video element
            splashImageFallback.style.backgroundImage = `url('${SPLASH_IMAGE_FALLBACK_URL}')`; // Set image source
            splashImageFallback.classList.add('show'); // Show the fallback image
        }

        function startSplashScreenSequence() {
            const splashAnimationDuration = 5000; // Total duration of text/icon animations
            const fadeOutDelay = 500; // Time after animations to start fade-out
            const splashFadeOutTransitionDuration = 800; // From CSS transition

            setTimeout(() => {
                splashScreen.classList.add('fade-out');
                // Directly hide splash and show main content after its fade-out completes
                setTimeout(() => {
                    splashScreen.style.display = 'none';
                    mainPageContent.classList.add('fade-in');
                    if (splashVideo) { // Pause video when hidden
                        splashVideo.pause();
                        splashVideo.currentTime = 0;
                    }
                }, splashFadeOutTransitionDuration);
            }, splashAnimationDuration + fadeOutDelay);
        }


        // --- Header Scroll Animation Logic (Simplified for fixed header) ---
        // The main header is now fixed and doesn't change on scroll, so the 'scrolled' class logic is removed.
        window.addEventListener('scroll', () => {
            setActiveNavItemOnScroll();
        });

        // --- Card Verification Logic ---
        verifyButton.addEventListener('click', () => {
            performVerification();
        });

        cardCodeInput.addEventListener('keypress', (e) => {
            // Allow only numbers and limit input to 4 digits
            if (!/\d/.test(e.key) || cardCodeInput.value.length >= 4) {
                e.preventDefault();
            }
            if (e.key === 'Enter') {
                performVerification();
            }
        });

        function performVerification() {
            const code = cardCodeInput.value;
            userProfileDisplay.classList.remove('show');
            verificationMessage.classList.remove('show', 'verified', 'fake');
            verificationMessage.textContent = '';
            userProfileDisplay.innerHTML = ''; // Clear previous profile

            if (code.length !== 4) {
                verificationMessage.textContent = 'Please enter a 4-digit code.';
                verificationMessage.classList.add('show', 'fake');
                return;
            }

            // Access verifiedUsers from the users.js file
            const user = verifiedUsers[code];

            if (user) {
                verificationMessage.textContent = 'VERIFIED! This user is safe and registered to our community.';
                verificationMessage.classList.add('show', 'verified');
                displayUserProfile(user);
            } else {
                verificationMessage.textContent = 'FAKE USER! This code is not registered. Do not chat with them.';
                verificationMessage.classList.add('show', 'fake');
                displayFakeUserMessage();
            }
            cardCodeInput.value = ''; // Clear input after verification
        }

        function displayUserProfile(user) {
            userProfileDisplay.innerHTML = `
                <img src="${user.picture}" alt="${user.name}">
                <h3>${user.name}</h3>
                <p><strong>Age:</strong> ${user.age}</p>
                <p><strong>Country:</strong> ${user.country}</p>
                <p><strong>State/Province:</strong> ${user.state_province}</p>
                <p><strong>City:</strong> ${user.city}</p>
                <p><strong>Sexuality:</strong> ${user.sexuality}</p>
                <p><strong>Body Type:</strong> ${user.body_type}</p>
                <p><strong>Height:</strong> ${user.height}cm</p>
                <p style="color:var(--text-light);"><strong>Interested in:</strong> "${user.interested_in}"</p>
            `;
            userProfileDisplay.classList.add('show');
        }

        function displayFakeUserMessage() {
             userProfileDisplay.innerHTML = `
                <h3 style="color:var(--error-color);">Unregistered User</h3>
                <p style="color:var(--text-muted);">This user's code is not recognized by True Match.</p>
                <p style="color:var(--text-muted);">For your safety, we advise against engaging with unverified individuals.</p>
                <p style="color:var(--text-muted);">Tell them to register with us via the "Join Community" button.</p>
            `;
            userProfileDisplay.classList.add('show');
        }

        // --- Modals Logic ---

        // Function to show any modal
        function showModal(modalElement) {
            modalElement.classList.add('show-modal');
            document.body.style.overflow = 'hidden'; // Prevent scrolling background
            // Ensure only the clicked nav item (if any) is active
            navItems.forEach(nav => nav.classList.remove('active'));
            // If the register nav item opened it, set it active
            if (modalElement === addCreateModal || modalElement === registrationModal) {
                registerNavItem.classList.add('active');
            }
        }

        // Function to hide any modal
        function hideModal(modalElement) {
            modalElement.classList.remove('show-modal');
            document.body.style.overflow = ''; // Restore scrolling background
            setActiveNavItemOnScroll(); // Re-evaluate active state for nav items
        }

        // Event Listeners for Modals

        registerNavItem.addEventListener('click', (e) => {
            e.preventDefault(); // Prevent default link behavior
            showModal(addCreateModal); // Open the Add or Create modal
        });

        addCreateModalCloseButton.addEventListener('click', () => {
            hideModal(addCreateModal);
        });

        addCreateModal.addEventListener('click', (e) => {
            if (e.target === addCreateModal) {
                hideModal(addCreateModal);
            }
        });

        // IMPORTANT: If "Create your Gay Card" should open the registration modal,
        // add an event listener here to `createGayCardLink` (the <a> tag)
        // and prevent its default behavior.
        createGayCardLink.addEventListener('click', (e) => {
            e.preventDefault(); // Prevent navigating
            hideModal(addCreateModal); // Close the Add or Create modal
            showModal(registrationModal); // Open the Registration modal
        });

        registrationModalCloseButton.addEventListener('click', () => {
            hideModal(registrationModal);
        });

        registrationModal.addEventListener('click', (e) => {
            if (e.target === registrationModal) {
                hideModal(registrationModal);
            }
        });

        // New Header Modal Event Listeners
        openLiveLink.addEventListener('click', (e) => {
            e.preventDefault();
            // This is a placeholder for your 'Live' page. You can add more functionality here.
            alert('Navigating to Live Content! (This link is a placeholder)');
            // For example, you might want to redirect: window.location.href = 'your-live-page.html';
        });

        openResourcesMenuModalLink.addEventListener('click', (e) => {
            e.preventDefault();
            showModal(resourcesMenuModal);
        });

        resourcesMenuCloseButton.addEventListener('click', () => {
            hideModal(resourcesMenuModal);
        });

        resourcesMenuModal.addEventListener('click', (e) => {
            if (e.target === resourcesMenuModal) {
                hideModal(resourcesMenuModal);
            }
        });


        // --- Paystack Integration & Form Submission ---
        registrationForm.addEventListener('submit', async function(e) {
            e.preventDefault(); // Prevent default form submission initially

            const form = this;
            const formData = new FormData(form);
            const name = formData.get('name');
            // For Paystack, we need an email. If you don't collect email on the form,
            // you might need a placeholder or add an email field to your form.
            // Using a dummy email here for demonstration.
            const email = `${name.replace(/\s+/g, '').toLowerCase().substring(0, 15)}@truematch.com`;

            if (!PAYSTACK_PUBLIC_KEY || PAYSTACK_PUBLIC_KEY === 'YOUR_PAYSTACK_PUBLIC_KEY') {
                alert('Please configure your Paystack Public Key in the JavaScript code.');
                return;
            }
            if (!FORMSPREE_ENDPOINT || FORMSPREE_ENDPOINT === 'YOUR_FORMSPREE_ENDPOINT') {
                 alert('Please configure your Formspree Endpoint in the JavaScript code.');
                 return;
                 return;
            }

            // Paystack Payment Initialization
            let handler = PaystackPop.setup({
                key: PAYSTACK_PUBLIC_KEY,
                email: email,
                amount: PAYMENT_AMOUNT_NAIRA * 100, // Amount in kobo
                currency: "NGN",
                ref: '' + Math.floor((Math.random() * 1000000000) + 1), // unique ref for each transaction
                metadata: {
                    custom_fields: {
                        full_name: name,
                        age: formData.get('age'),
                        country: formData.get('country'),
                        state_province: formData.get('state_province'),
                        city: formData.get('city'),
                        sexuality: formData.get('sexuality'),
                        body_type: formData.get('body_type'),
                        height: formData.get('height'),
                        interested_in: formData.get('interested_in')
                    }
                },
                callback: function(response){
                    // Payment successful
                    alert('Payment successful! Reference: ' + response.reference);

                    // --- Submit form data to Formspree using fetch ---
                    // Convert FormData to plain object for JSON submission
                    const data = {};
                    for (let [key, value] of formData.entries()) {
                        data[key] = value;
                    }
                    data['paystack_reference'] = response.reference; // Add Paystack ref to data

                    fetch(FORMSPREE_ENDPOINT, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        },
                        body: JSON.stringify(data)
                    })
                    .then(response => {
                        if (response.ok) {
                            console.log('Form data successfully sent to Formspree!');

                            // IMPORTANT: In a real application, you would add the user to your backend database here
                            // and then get a new unique code for them. For this frontend-only example,
                            // we'll simulate adding them to the `verifiedUsers` object from `users.js`.
                            // You'll need to generate a unique 4-digit code if you're adding new users this way.
                            const newUserCode = Math.floor(1000 + Math.random() * 9000).toString(); // Simple random code

                            // Assuming the form data matches the user object structure
                            const newUserData = {
                                name: formData.get('name'),
                                picture: `https://via.placeholder.com/120/CCCCCC/000000?text=${formData.get('name').split(' ').map(n=>n[0]).join('')}`, // Generate placeholder image based on initials
                                age: parseInt(formData.get('age')),
                                country: formData.get('country'),
                                state_province: formData.get('state_province'),
                                city: formData.get('city'),
                                sexuality: formData.get('sexuality'),
                                body_type: formData.get('body_type'),
                                height: parseInt(formData.get('height')),
                                interested_in: formData.get('interested_in'),
                                is_verified: true
                            };

                            // Use the addUser function from users.js
                            addUser(newUserCode, newUserData);
                            console.log(`New user (simulation): ${newUserData.name} added with code ${newUserCode}`);

                        } else {
                            console.error('Formspree submission failed:', response.statusText);
                            alert('Registration data could not be saved. Please contact support.');
                        }
                    })
                    .catch(error => {
                        console.error('Network error during Formspree submission:', error);
                        alert('A network error occurred during registration. Please try again.');
                    })
                    .finally(() => {
                        hideModal(registrationModal);
                        showSuccessMessage();
                        // Reset form after submission (optional)
                        form.reset();
                    });
                },
                onClose: function(){
                    // User closed payment modal
                    alert('Payment process cancelled. You can try again.');
                }
            });
            handler.openIframe(); // Open the Paystack checkout
        });

        function showSuccessMessage() {
            joinCommunitySection.style.display = 'none'; // Hide the "Join Community" button section
            joinSuccessMessage.style.display = 'block'; // Show the success message
            setTimeout(() => {
                joinSuccessMessage.classList.add('show');
            }, 10); // Small delay for CSS transition
        }

        // --- Bottom Navigation Active State & Smooth Scroll ---
        function setActiveNavItemOnScroll() {
            // If any modal is open, ensure the register nav item is active
            if (addCreateModal.classList.contains('show-modal') || registrationModal.classList.contains('show-modal') || resourcesMenuModal.classList.contains('show-modal')) {
                navItems.forEach(nav => nav.classList.remove('active'));
                registerNavItem.classList.add('active');
                return; // Stop here, modal state overrides scroll state
            }

            // Otherwise, determine active state based on scroll position
            const currentScrollPos = window.scrollY + window.innerHeight / 2; // Mid-point of viewport

            navItems.forEach(nav => {
                // Remove active class from all first, then add to relevant one
                nav.classList.remove('active');

                const href = nav.getAttribute('href');
                if (href && href.startsWith('#')) {
                    const targetElement = document.querySelector(href);
                    if (targetElement) {
                        if (currentScrollPos >= targetElement.offsetTop &&
                            currentScrollPos < targetElement.offsetTop + targetElement.offsetHeight) {
                            nav.classList.add('active');
                        }
                    }
                } else if (nav.id === 'homeNavItem') {
                    const faqOffset = faqSectionTitle ? faqSectionTitle.offsetTop : Infinity;
                    if (window.scrollY < faqOffset - (window.innerHeight / 4)) {
                        nav.classList.add('active'); // Keep it active
                    }
                }
            });
            // Final check to ensure home is active if nothing else is, especially at the very top.
            let anyOtherNavActive = Array.from(navItems).some(nav => nav.id !== 'homeNavItem' && nav.classList.contains('active'));
            if (!anyOtherNavActive && window.scrollY < 150) { // Small buffer from top
                homeNavItem.classList.add('active');
            }
        }

        document.querySelectorAll('a[href^="#"]').forEach(anchor => {
            anchor.addEventListener('click', function (e) {
                const targetId = this.getAttribute('href');
                const targetElement = document.querySelector(targetId === '#' ? 'body' : targetId); // Scroll to body for '#'
                if (targetElement) {
                    e.preventDefault();
                    targetElement.scrollIntoView({
                        behavior: 'smooth'
                    });
                    setTimeout(setActiveNavItemOnScroll, 600); // Give time for scroll to finish
                }
            });
        });

        // --- FAQ Accordion Logic ---
        document.querySelectorAll('.faq-question').forEach(question => {
            question.addEventListener('click', () => {
                const faqItem = question.closest('.faq-item');
                const answer = faqItem.querySelector('.faq-answer');

                question.classList.toggle('active');
                faqItem.classList.toggle('active');

                if (answer.style.maxHeight) {
                    answer.style.maxHeight = null; // Collapse the answer
                } else {
                    answer.style.maxHeight = answer.scrollHeight + "px"; // Expand the answer
                }
            });
        });

    </script>
</body>
</html>
